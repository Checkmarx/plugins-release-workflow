# Centralized GitHub Action for Jira Notification (.github/workflows/jira_notify.yml)
name: Notify Jira

on:
  workflow_call:
    inputs:
      title:
        description: 'Issue title'
        required: true
        type: string
      body:
        description: 'Body'
        required: true
        type: string
      html_url:
        description: 'URL'
        required: true
        type: string
      repo:
        description: 'Repository name'
        required: true
        type: string

jobs:
  notify_jira:
    runs-on: ubuntu-latest
    env:
      JIRA_URL: "https://checkmarx.atlassian.net/"
    steps:
      - name: Jira Login
        uses: atlassian/gajira-login@ca13f8850ea309cf44a6e4e0c49d9aa48ac3ca4c #v3
        env:
          JIRA_BASE_URL: ${{ env.JIRA_URL }}
          JIRA_USER_EMAIL: ${{ secrets.AST_JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.AST_JIRA_API_TOKEN }}

      - name: Determine Issue Type
        id: issue_type
        run: |
          if [[ "${{ inputs.title }}" == *"[BUG]"* ]]; then
            echo "is_bug=true" >> $GITHUB_ENV
            echo "Selected Issue Type: BUG"
          else
            echo "is_bug=false" >> $GITHUB_ENV
            echo "Selected Issue Type: OTHER"
          fi

      - name: Format Jira Description
        id: format_description
        run: |
          echo "FORMATTED_DESCRIPTION=**Issue Title:** ${{ inputs.title }}%0A%0A**Repository:** ${{ inputs.repo }}%0A%0A**Description:**%0A${{ inputs.body }}%0A%0A[View original issue](${{ inputs.html_url }})" >> $GITHUB_ENV
      

      - name: Create Jira Issue for Bug
        if: env.is_bug == 'true'
        id: create_jira_bug
        uses: atlassian/gajira-create@1ff0b6bd115a780592b47bfbb63fc4629132e6ec #v3
        with:
          project: AST
          issuetype: Task
          summary: '${{ inputs.repo }} ${{ inputs.title }}'
          description: '${{ env.FORMATTED_DESCRIPTION }}'
          fields: ${{ secrets.JIRA_FIELDS_BUG }}

      - name: Create Jira Issue for Other
        if: env.is_bug == 'false'
        id: create_jira_other
        uses: atlassian/gajira-create@1ff0b6bd115a780592b47bfbb63fc4629132e6ec #v3
        with:
          project: AST
          issuetype: Task
          summary: '${{ inputs.repo }} ${{ inputs.title }}'
          description: '${{ inputs.body }} see more at ${{ inputs.html_url }}'
          fields: ${{ secrets.JIRA_FIELDS_OTHER }}

      - name: Add comment to GitHub issue
        uses: actions/github-script@v4.0.2
        with:
          script: |
            issue_id = process.env.is_bug == 'true' ? "${{ steps.create_jira_bug.outputs.issue }}" : "${{ steps.create_jira_other.outputs.issue }}"
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Internal Jira issue: [' + issue_id + '](${{ env.JIRA_URL }}/browse/' + issue_id + ')'
            })